#!/bin/bash

set -e

EXE="${1:-}"
declare -A files

log()
{
    echo "$(indenter) # $@" >&2
}

indent=0

indenter()
{
    for(( i=0; i<${indent}; i++ )); do
        if (( i % 4 == 0 )); then
            echo -n "|"
        fi
        echo -n " "
    done
    echo -n "| "
}

dependencies()
{
    (( indent += 4 ))
    DEPFILE="${1}"
    if [[ -n "${files["${DEPFILE}"]}" ]]; then
        #log "$(indenter) ### Skipping dependencies in ${DEPFILE}"
        return 0
    fi
    files["${DEPFILE}"]="true"
    DEPS="$(cat "${DEPFILE}" | tr '\\' ' ' | tr '\n' ' ' | cut -d: -f2)"

    #log "$(indenter) --- Checking dependencies in ${DEPFILE}"

    for dep in ${DEPS}; do
        #log "Dep: ${dep}"
        filename="$(basename ${dep})"

        if [[ -n "${files["${dep}"]}" ]]; then
            #log "Already have a dependency for file ${dep}"
            continue
        fi
        files["${dep}"]="true"

        if [[ "${filename}" =~ \.(h|hpp)$ ]]; then
            objfile="$(echo -n ${filename} | sed -E "s/(.*)?\.(h|hpp)$/\1.o/")"
            subdepfile="$(echo -n ${filename} | sed -E "s/(.*)?\.(h|hpp)$/\1.d/")"
            objpath="$(find "$(pwd)" -path "*/s/${objfile}" -a -type f)"
            subdeppath="$(find "$(pwd)" -path "*/s/${subdepfile}" -a -type f)"

            #log "Found a header: ${filename}, searching for ${objfile}"
            if [[ -n "${objpath}" ]]; then
                #log "Found object ${objpath}"
                if [[ -n "${subdeppath}" ]]; then
                    #log "More dependencies with ${subdeppath}"
                    dependencies "${subdeppath}"
                fi

                if [[ -n "${files["${objpath:-NONE}"]}" ]]; then
                    continue
                fi
                files["${objpath:-NONE}"]="true"
                echo "${objpath}"
            else
                #log "No object found."
                echo "${dep}"
            fi
        elif [[ "${filename}" =~ \.(c|cpp)$ ]]; then
            objfile="$(echo -n ${filename} | sed -E "s/(.*)?\.(c|cpp)$/\1.o/")"
            objpath="$(find "$(pwd)" -path "*/s/${objfile}" -a -type f)"

            if [[ -n "${objpath}" ]]; then
                if [[ -n "${files["${objpath:-NONE}"]}" ]]; then
                    continue
                fi
                files["${objpath:-NONE}"]="true"
                echo "${objpath}"
            fi

        #else
            #log "Not a file of interest... ${filename}"
        fi
    done
    (( indent -= 4 ))
    return 0
}

#log "Building dependencies for: ${EXE}"
echo "$(pwd)/build/application/${EXE}/main.o"
dependencies "build/application/${EXE}/main.d"
