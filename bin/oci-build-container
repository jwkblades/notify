#!/bin/bash
source ./bin/utils.sh

findFlavor()
{
    find ./containers -name "Containerfile.${1}"
}

fileFlavor()
{
    local file="${1}"
    echo -n "${file}" | cut -d. -f3
}

containerType()
{
    echo -n "$(basename $(dirname "${1}"))"
}

buildFlavor()
{
    local container="${1}"
    local flavor="$(fileFlavor "${container}")"
    local type="$(containerType "${container}")"
    local version="$(./bin/version)"
    warning "Searching for container image ${flavor}_notify_${type}:${version}"
    if ./bin/oci-exec image exists "${flavor}_notify_${type}:${version}"; then
        log "Container ${flavor}_notify_${type}:${version} exists, skipping."
        return 0
    fi

    ./bin/oci-exec build -f "${container}" --tag=${flavor}_notify_${type}:latest --tag=${flavor}_notify_${type}:${version}
}

: ${FLAVOR="fedora"}

for container in $(findFlavor "${FLAVOR}"); do
    log "Building container: ${container}"
    buildFlavor ${container}
done
